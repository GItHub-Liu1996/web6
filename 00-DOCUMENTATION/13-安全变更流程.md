# GoChinaAdvisors (仮) 安全变更流程

## 📋 概述

本文档定义了UI组件库的严格变更控制流程，确保组件修改不会影响系统稳定性。我们采用"坚实地基 + 严格的变更管理"策略，通过两阶段实施来保障项目质量。

## 🎯 核心原则

### **1. 零容忍原则**
任何对UI组件库的修改都必须遵循严格的变更流程，不允许任何"快速修复"或"临时方案"。

### **2. Storybook优先原则**
所有UI组件开发、调试、测试都必须在Storybook中进行，禁止直接在业务页面中调试UI组件。

### **3. 回归测试原则**
每次修改后都必须进行完整的回归测试，确保没有破坏现有功能。

### **4. 文档同步原则**
任何组件修改都必须同步更新相关文档和测试用例。

## 🏗️ 两阶段实施策略

### **第一阶段：地基建设 - UI轮子库**

#### **目标**
构建完美的UI组件库，不涉及任何业务页面开发。

#### **范围**
- `src/components/ui/` - UI原子组件
- `src/components/layout/` - 布局工具组件
- `src/components/molecules/` - 分子组件

#### **验收标准**
- ✅ 每个组件都有完整的Storybook故事
- ✅ 每个组件都有对应的单元测试
- ✅ 所有props组合和状态都在Storybook中展示
- ✅ 组件在Storybook中看起来完美无瑕

#### **当前状态**
**UI原子组件 (src/components/ui/)**:
- ✅ Button.tsx - 需要完善Storybook故事
- ✅ Input.tsx - 需要完善Storybook故事
- ✅ Card.tsx - 需要完善Storybook故事
- ✅ Badge.tsx - 需要完善Storybook故事
- ✅ Separator.tsx - 需要完善Storybook故事
- 🔄 Modal.tsx - 需要创建和完善
- 🔄 Toast.tsx - 需要创建和完善
- 🔄 Loading.tsx - 需要创建和完善
- 🔄 Avatar.tsx - 需要创建和完善

**布局工具组件 (src/components/layout/)**:
- ✅ Container.tsx - 需要完善Storybook故事
- ✅ Grid.tsx - 需要完善Storybook故事
- ✅ Stack.tsx - 需要完善Storybook故事

**分子组件 (src/components/molecules/)**:
- ✅ LabeledInput.tsx - 需要创建Storybook故事
- ✅ FormField.tsx - 需要创建Storybook故事
- ✅ SearchBox.tsx - 需要创建Storybook故事

### **第二阶段：安全保障 - 变更控制流程**

## 🔒 高风险操作识别

以下操作被定义为"高风险操作"，必须严格遵循变更流程：

### **1. UI原子组件修改**
- `src/components/ui/` 目录下的任何文件修改
- 包括：新增、删除、修改组件文件
- 包括：修改组件的Props接口、样式、行为

### **2. 布局工具组件修改**
- `src/components/layout/` 目录下的任何文件修改
- 包括：修改Container、Grid、Stack等布局组件

### **3. 分子组件修改**
- `src/components/molecules/` 目录下的任何文件修改
- 包括：修改LabeledInput、FormField、SearchBox等分子组件

### **4. 相关配置文件修改**
- `tailwind.config.js` - 样式配置修改
- `src/lib/utils.ts` - 工具函数修改
- `src/types/index.ts` - 类型定义修改

## 📋 五步变更流程

### **步骤1: 创建专属分支**
```bash
# 创建功能分支
git checkout -b feat/update-button-style

# 或创建修复分支
git checkout -b fix/input-validation-bug

# 或创建重构分支
git checkout -b refactor/card-component-api
```

**要求**:
- 分支命名必须清晰描述修改内容
- 使用 `feat/`、`fix/`、`refactor/` 前缀
- 不允许在main分支直接修改UI组件

### **步骤2: Storybook优先开发**
**核心原则**: 禁止直接在业务页面中调试UI组件

**操作流程**:
1. **启动Storybook**: `npm run storybook`
2. **定位组件**: 在Storybook中找到要修改的组件
3. **重现问题**: 在Storybook中重现需要修改的问题或场景
4. **开发新特性**: 在Storybook中开发新功能
5. **实时预览**: 使用Storybook的热重载功能实时查看修改效果

**Storybook故事要求**:
- **基础状态**: 默认样式和基本用法
- **变体状态**: 所有variant选项（primary, secondary, outline等）
- **尺寸状态**: 所有size选项（sm, md, lg等）
- **交互状态**: hover, focus, active, disabled状态
- **加载状态**: loading状态
- **错误状态**: error状态
- **边界情况**: 空值、长文本、特殊字符等边界情况

### **步骤3: 回归测试**
**目标**: 确保修改没有破坏其他功能

**检查清单**:
- [ ] **所有故事正常**: 在Storybook中检查该组件的所有其他"故事"
- [ ] **视觉回归**: 对比修改前后的视觉效果
- [ ] **功能回归**: 确保所有功能仍然正常工作
- [ ] **跨浏览器**: 在不同浏览器中测试（Chrome, Firefox, Safari）
- [ ] **响应式**: 在不同屏幕尺寸下测试
- [ ] **无障碍**: 确保无障碍功能正常

**回归测试示例**:
```
修改Button组件的主样式后，需要检查：
- Primary按钮样式是否正确
- Secondary按钮是否受影响
- Outline按钮是否受影响
- Ghost按钮是否受影响
- Link按钮是否受影响
- 所有尺寸（sm, md, lg）是否正常
- 禁用状态是否正常
- 加载状态是否正常
```

### **步骤4: 单元测试更新**
**目标**: 确保代码逻辑正确

**操作流程**:
1. **运行现有测试**: `npm test` 确保所有测试通过
2. **更新测试用例**: 根据新功能更新测试用例
3. **添加新测试**: 为新功能添加测试用例
4. **检查覆盖率**: 确保测试覆盖率不降低
5. **边界测试**: 添加边界情况的测试用例

**测试要求**:
- **功能测试**: 测试组件的核心功能
- **Props测试**: 测试所有Props的正确处理
- **事件测试**: 测试用户交互事件
- **状态测试**: 测试组件的各种状态
- **边界测试**: 测试边界情况和错误处理

### **步骤5: 代码审查**
**目标**: 确保代码质量和一致性

**审查流程**:
1. **提交代码**: `git push origin feat/update-button-style`
2. **创建PR**: 在GitHub上创建Pull Request
3. **审查检查**: 审查者进行代码审查
4. **Storybook审查**: 审查者在Storybook中检查视觉表现
5. **合并代码**: 审查通过后合并到main分支

**审查检查清单**:
- [ ] **代码规范**: 遵循项目的代码规范
- [ ] **类型安全**: TypeScript类型定义正确
- [ ] **JSDoc文档**: 组件文档完整且准确
- [ ] **Storybook故事**: 所有场景都有对应的故事
- [ ] **单元测试**: 测试用例完整且通过
- [ ] **视觉表现**: 在Storybook中视觉效果正确
- [ ] **无障碍性**: 组件符合无障碍标准
- [ ] **性能影响**: 修改没有影响性能

## 🛠️ 工具配置

### **Storybook配置**
**配置文件**: `.storybook/main.ts`
```typescript
import type { StorybookConfig } from '@storybook/nextjs';

const config: StorybookConfig = {
  stories: ['../src/**/*.stories.@(js|jsx|ts|tsx)'],
  addons: [
    '@storybook/addon-essentials',
    '@storybook/addon-interactions',
    '@storybook/addon-a11y', // 无障碍测试
    '@storybook/addon-viewport', // 响应式测试
  ],
  framework: {
    name: '@storybook/nextjs',
    options: {},
  },
  typescript: {
    check: false,
    reactDocgen: 'react-docgen-typescript',
  },
};

export default config;
```

**启动命令**:
```bash
# 开发模式
npm run storybook

# 构建静态版本
npm run build-storybook
```

### **测试工具配置**
**Jest配置**: `jest.config.js`
```javascript
const nextJest = require('next/jest');

const createJestConfig = nextJest({
  dir: './',
});

const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  testEnvironment: 'jest-environment-jsdom',
  testMatch: [
    '<rootDir>/src/**/__tests__/**/*.{js,jsx,ts,tsx}',
    '<rootDir>/src/**/*.{test,spec}.{js,jsx,ts,tsx}',
  ],
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.stories.{js,jsx,ts,tsx}',
  ],
};

module.exports = createJestConfig(customJestConfig);
```

**测试命令**:
```bash
# 运行所有测试
npm test

# 运行测试并生成覆盖率报告
npm run test:coverage

# 监听模式
npm run test:watch
```

### **CI/CD集成**
**GitHub Actions配置**: `.github/workflows/ui-components.yml`
```yaml
name: UI Components Safety Check

on:
  pull_request:
    paths:
      - 'src/components/ui/**'
      - 'src/components/layout/**'
      - 'src/components/molecules/**'

jobs:
  ui-safety-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run test
      - run: npm run build-storybook
      - run: npm run type-check
```

## ✅ 检查清单

### **开发前检查**
- [ ] 确认修改属于高风险操作范围
- [ ] 创建专属Git分支
- [ ] 启动Storybook环境
- [ ] 在Storybook中定位目标组件

### **开发中检查**
- [ ] 在Storybook中重现问题或开发新特性
- [ ] 实时预览修改效果
- [ ] 确保所有Props组合都正常工作
- [ ] 测试各种状态和变体

### **提交前检查**
- [ ] 运行完整的回归测试
- [ ] 更新或添加单元测试
- [ ] 更新JSDoc文档
- [ ] 在Storybook中验证所有故事
- [ ] 检查代码规范和类型安全

### **审查检查**
- [ ] 代码质量审查
- [ ] Storybook视觉审查
- [ ] 测试用例审查
- [ ] 文档完整性审查
- [ ] 无障碍性审查

## 🚨 应急处理

### **发现问题时的处理流程**
1. **立即停止**: 发现问题后立即停止相关开发
2. **评估影响**: 评估问题的影响范围和严重程度
3. **创建修复分支**: `git checkout -b hotfix/ui-component-issue`
4. **在Storybook中修复**: 在Storybook中重现并修复问题
5. **紧急测试**: 进行快速但全面的测试
6. **紧急合并**: 通过紧急流程合并修复

### **回滚策略**
1. **识别问题版本**: 确定导致问题的具体提交
2. **创建回滚分支**: `git checkout -b rollback/ui-component-fix`
3. **回滚到稳定版本**: 回滚到最后一个稳定版本
4. **验证回滚**: 确保回滚后系统正常
5. **通知团队**: 通知所有团队成员回滚情况

### **问题报告模板**
```markdown
## 🚨 UI组件问题报告

**问题描述**: 
**影响范围**: 
**重现步骤**: 
**预期行为**: 
**实际行为**: 
**Storybook链接**: 
**修复方案**: 
**测试结果**: 
```

## 📊 质量指标

### **覆盖率要求**
- **单元测试覆盖率**: ≥ 90%
- **Storybook故事覆盖率**: 100%（所有Props组合）
- **类型覆盖率**: 100%

### **性能要求**
- **组件渲染时间**: < 16ms
- **包大小影响**: 单个组件 < 5KB
- **无障碍评分**: ≥ 95分

### **文档要求**
- **JSDoc覆盖率**: 100%
- **Storybook故事**: 每个组件至少5个故事
- **使用示例**: 每个组件都有完整的使用示例

## 🔄 流程优化

### **定期回顾**
- **月度回顾**: 每月回顾流程执行情况
- **季度优化**: 每季度优化流程和工具
- **年度升级**: 每年升级工具和最佳实践

### **持续改进**
- **收集反馈**: 收集开发者的使用反馈
- **优化工具**: 根据实际使用情况优化工具配置
- **更新文档**: 根据实际经验更新流程文档

---

**文档版本**: v1.0.0  
**最后更新**: 2024年1月  
**维护者**: 开发团队  
**项目**: GoChinaAdvisors (仮)

**重要提醒**: 这个流程是强制性的，任何UI组件修改都必须严格遵循此流程。违反流程的修改将被拒绝合并。
